rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isLoggedIn() {
      return request.auth != null;
    }
    
    // ============================================
    // KUNDEN-COLLECTIONS
    // ============================================
    match /kunden/{kundenId} {
      allow read, write: if isLoggedIn();
      
      // ============================================
      // MITARBEITER COLLECTION
      // ============================================
      // Erlaube unauthentifizierten Benutzern, die mitarbeiter Collection zu lesen
      // Dies ist notwendig für den Login mit Personalnummer
      // ⚠️ SICHERHEIT: Nur Lesezugriff für Login-Zwecke
      match /mitarbeiter/{mitarbeiterId} {
        // Erlaube Lesen für alle (auch unauthentifizierte Benutzer)
        // Dies ist notwendig, um nach Personalnummern zu suchen beim Login
        allow read: if true;
        
        // Schreiben nur für authentifizierte Benutzer
        allow write: if isLoggedIn();
      }
      
      match /users/{userId} {
        allow read, write: if isLoggedIn();
        
        match /userTiles/{docId} {
          allow read, write: if isLoggedIn();
        }
      }
      
      match /modules/{moduleId} {
        allow read, write: if isLoggedIn();
      }
      
      // Alle anderen Collections unter kunden/{kundenId}
      match /{document=**} {
        allow read, write: if isLoggedIn();
      }
    }
    
    // Globale Module
    match /modules/{moduleId} {
      allow read, write: if isLoggedIn();
    }
    
    // ============================================
    // SETTINGS COLLECTION
    // ============================================
    match /settings/{settingId} {
      allow read, write: if isLoggedIn();
      
      match /{document=**} {
        allow read, write: if isLoggedIn();
      }
    }
  }
}
