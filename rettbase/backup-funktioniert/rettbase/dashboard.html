<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>RettBase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#00bcd4" />
  <link rel="icon" type="image/png" href="/RBapp.png" sizes="32x32">
  <link rel="apple-touch-icon" href="/RBapp.png">
  <link rel="manifest" href="/manifest.json">
  
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>
  <header>
    <button id="menuToggle">
      <div></div>
      <div></div>
      <div></div>
    </button>
    <img src="/img/rettbase.png" alt="RettBase Logo" style="height: 40px;">
    
    <div style="margin-left: auto; position: relative;">
      <button id="userMenuToggle" class="user-menu-toggle">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink: 0;">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span id="userNameDisplay">L√§dt...</span>
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink: 0;">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </button>
      <div id="userDropdownMenu" class="user-dropdown-menu" style="display: none;">
        <a href="#" class="user-menu-item" id="profileLink">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          <span>Profil</span>
        </a>
        <a href="#" class="user-menu-item" id="posteingangLink">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="4" width="20" height="16" rx="2"></rect>
            <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path>
          </svg>
          <span>Posteingang</span>
        </a>
      </div>
    </div>
  </header>

  <div id="menuBackdrop" class="menu-backdrop" style="display: none;"></div>
  <div id="dropdownMenu" class="dropdown-menu">
    <!-- Wird dynamisch von dashboard.js gef√ºllt -->
    <a href="#" class="menu-item" id="logoutLink">Logout</a>
  </div>

  <main>
    <iframe id="contentFrame" src="home.html" frameborder="0"></iframe>
  </main>

  <script type="module" src="./dashboard.js"></script>
  <script type="module">
    // Lade Initialisierungs-Script f√ºr manuelle Ausf√ºhrung
    import('./init-firestore.js').then(() => {
      console.log('üí° Initialisierungs-Script geladen. F√ºhre aus: await initializeFirestore()');
    }).catch(err => {
      console.warn('‚ö†Ô∏è Initialisierungs-Script konnte nicht geladen werden:', err);
    });
  </script>
  
  <!-- Service Worker f√ºr automatische Updates -->
  <script>
    // Service Worker Registrierung
    if ('serviceWorker' in navigator) {
      let refreshing = false;
      
      // Registriere Service Worker
      navigator.serviceWorker.register('/service-worker.js')
        .then((registration) => {
          console.log('‚úÖ Service Worker registriert:', registration.scope);
          
          // Pr√ºfe auf Updates beim Laden
          registration.addEventListener('updatefound', () => {
            console.log('üîÑ Neuer Service Worker gefunden!');
            const newWorker = registration.installing;
            
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // Neuer Service Worker ist bereit, aber noch nicht aktiv
                console.log('üì¶ Neuer Service Worker bereit. Zeige Update-Benachrichtigung...');
                showUpdateNotification();
              }
            });
          });
          
          // Pr√ºfe regelm√§√üig auf Updates (alle 60 Sekunden)
          setInterval(() => {
            registration.update();
          }, 60000);
        })
        .catch((error) => {
          console.error('‚ùå Service Worker Registrierung fehlgeschlagen:', error);
        });
      
      // Listener f√ºr Service Worker Updates
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!refreshing) {
          console.log('üîÑ Neuer Service Worker aktiv. Seite wird neu geladen...');
          refreshing = true;
          window.location.reload();
        }
      });
      
      // Funktion zum Anzeigen der Update-Benachrichtigung
      function showUpdateNotification() {
        // Erstelle ein Update-Banner
        const banner = document.createElement('div');
        banner.id = 'update-banner';
        banner.style.cssText = `
          position: fixed;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: #00bcd4;
          color: white;
          padding: 15px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
          z-index: 10000;
          display: flex;
          align-items: center;
          gap: 15px;
          font-family: 'Segoe UI', sans-serif;
          font-size: 14px;
          max-width: 90%;
        `;
        
        banner.innerHTML = `
          <span>üîÑ Neue Version verf√ºgbar!</span>
          <button id="update-btn" style="
            background: white;
            color: #00bcd4;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
          ">Jetzt aktualisieren</button>
          <button id="dismiss-btn" style="
            background: transparent;
            color: white;
            border: 1px solid white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
          ">Sp√§ter</button>
        `;
        
        document.body.appendChild(banner);
        
        // Update-Button
        document.getElementById('update-btn').addEventListener('click', () => {
          if (navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
          }
          banner.remove();
        });
        
        // Dismiss-Button
        document.getElementById('dismiss-btn').addEventListener('click', () => {
          banner.remove();
        });
        
        // Auto-Entfernen nach 10 Sekunden (optional)
        // setTimeout(() => banner.remove(), 10000);
      }
    } else {
      console.warn('‚ö†Ô∏è Service Worker wird nicht unterst√ºtzt');
    }
  </script>
</body>
</html>