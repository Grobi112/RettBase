<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Adminbereich ‚Äì Protect-Alert</title>

  <script type="module">
    import { auth, db } from "./firebase-config.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    window.addEventListener("DOMContentLoaded", () => {
      const grid = document.getElementById("homeGrid");
      const contextMenu = document.getElementById("contextMenu");
      const totalTiles = 9;
      let currentTileIndex = null;
      let userUID = null;
      let tiles = Array(totalTiles).fill(null);

      const menuOptions = [
        { label: "Home", page: "home.html" },
        { label: "Whiteboard", page: "whiteboard/whiteboard.html" },
        { label: "Benutzer", page: "admin-users.html" },
        { label: "Logout", page: "logout" },
        { label: "Leeren", page: null }
      ];

      const icons = {
        Home: `<path d="M3 9.5L12 3l9 6.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V9.5z"/>`,
        Whiteboard: `<rect x="9" y="2" width="6" height="4" rx="1" ry="1"></rect><path d="M9 2H5a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2h-4"></path>`,
        Benutzer: `<circle cx="12" cy="7" r="4"></circle><path d="M5.5 21a7 7 0 0 1 13 0"></path>`,
        Logout: `<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line>`,
        Plus: `<circle cx="12" cy="12" r="9"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line>`
      };

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "login.html";
          return;
        }
        userUID = user.uid;

        const saved = localStorage.getItem(`adminTiles_${userUID}`);
        if (saved) tiles = JSON.parse(saved);
        renderGrid();
        await mergeFromFirestore();
      });

      function renderGrid() {
        grid.innerHTML = "";
        for (let i = 0; i < totalTiles; i++) {
          const tile = tiles[i];
          const div = document.createElement("div");
          div.classList.add("grid-item");
          if (!tile) div.classList.add("placeholder");
          div.dataset.index = i;

          div.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
              ${icons[tile?.label || "Plus"]}
            </svg>
            <div class="label">${tile?.label || "+"}</div>
          `;

          div.addEventListener("click", () => {
            if (tile && tile.page) navigate(tile.page);
          });

          div.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            currentTileIndex = i;
            showContextMenu(e.pageX, e.pageY);
          });

          let pressTimer;
          let longPressFired = false;
          let startX = 0, startY = 0;

          div.addEventListener("touchstart", (e) => {
            e.preventDefault();
            longPressFired = false;
            const t = e.touches[0];
            startX = t.clientX;
            startY = t.clientY;
            pressTimer = setTimeout(() => {
              longPressFired = true;
              currentTileIndex = i;
              showContextMenu(t.pageX, t.pageY);
            }, 600);
          }, { passive: false });

          div.addEventListener("touchmove", (e) => {
            const t = e.touches[0];
            if (Math.abs(t.clientX - startX) > 10 || Math.abs(t.clientY - startY) > 10)
              clearTimeout(pressTimer);
          });

          div.addEventListener("touchend", () => {
            clearTimeout(pressTimer);
            if (!longPressFired && tile && tile.page) navigate(tile.page);
          });

          grid.appendChild(div);
        }
      }

      function showContextMenu(x, y) {
        contextMenu.innerHTML = "";
        menuOptions.forEach(opt => {
          const btn = document.createElement("button");
          btn.textContent = opt.label;
          btn.addEventListener("click", () => setTile(opt));
          contextMenu.appendChild(btn);
        });
        contextMenu.style.left = `${x}px`;
        contextMenu.style.top = `${y}px`;
        contextMenu.style.display = "flex";
      }

      document.addEventListener("click", (e) => {
        if (!contextMenu.contains(e.target)) contextMenu.style.display = "none";
      });

      async function setTile(option) {
        if (option.page === null) tiles[currentTileIndex] = null;
        else tiles[currentTileIndex] = option;
        localStorage.setItem(`adminTiles_${userUID}`, JSON.stringify(tiles));
        await saveToFirestore();
        renderGrid();
        contextMenu.style.display = "none";
      }

      async function saveToFirestore() {
        try {
          const ref = doc(db, "users", userUID, "adminTiles", "config");
          await setDoc(ref, { tiles: tiles }, { merge: true });
        } catch (e) {
          console.warn("‚ö†Ô∏è Firestore konnte nicht gespeichert werden:", e);
        }
      }

      async function mergeFromFirestore() {
        try {
          const ref = doc(db, "users", userUID, "adminTiles", "config");
          const snap = await getDoc(ref);
          if (!snap.exists()) return;
          const remote = snap.data().tiles;
          if (!remote) return;
          let changed = false;
          for (let i = 0; i < remote.length; i++) {
            if (!tiles[i] && remote[i]) {
              tiles[i] = remote[i];
              changed = true;
            } else if (remote[i] === null && tiles[i] !== null) {
              tiles[i] = null;
              changed = true;
            }
          }
          if (changed) {
            localStorage.setItem(`adminTiles_${userUID}`, JSON.stringify(tiles));
            renderGrid();
          }
        } catch (e) {
          console.warn("‚ö†Ô∏è Firestore konnte nicht geladen werden:", e);
        }
      }

      function navigate(page) {
        if (!page) return;
        if (page === "logout") {
          import("./auth.js").then(mod => mod.logout());
          return;
        }
        const frame = window.parent?.document.getElementById("contentFrame");
        if (frame) frame.src = page;
        else window.location.href = page;
      }
    });
  </script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", sans-serif;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      background: #f4f5f7;
      color: #1e1f26;
      padding: 24px 0 32px;
    }

    h1 {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    h1 span {
      color: #4fc3f7;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      width: 90%;
      max-width: 420px;
      justify-items: center;
    }

    .grid-item {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      cursor: pointer;
      width: 80px;
      height: 80px;
      text-align: center;
      color: #1e1f26;
    }

    .grid-item:hover {
      background: #e8f5fe;
      transform: translateY(-2px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.18);
    }

    .grid-item svg {
      width: 28px;
      height: 28px;
      stroke: #1e1f26;
      stroke-width: 1.8;
      margin-bottom: 5px;
    }

    .label {
      font-size: 12px;
      font-weight: 500;
    }

    .placeholder {
      background: #e0e0e0;
    }

    .placeholder svg {
      stroke: #888;
    }

    .context-menu {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      z-index: 100;
      padding: 5px 0;
    }

    .context-menu button {
      background: none;
      border: none;
      padding: 8px 16px;
      text-align: left;
      width: 100%;
      font-size: 14px;
      cursor: pointer;
    }

    .context-menu button:hover {
      background: #f0f0f0;
    }
  </style>
</head>
<!-- üîÑ Automatische WebApp-Aktualisierung -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/service-worker.js")
    .then(() => console.log("‚úÖ Service Worker aktiv"))
    .catch((err) => console.warn("‚ö†Ô∏è Service Worker Fehler:", err));

  // Neue Version erkannt? -> Seite neu laden
  navigator.serviceWorker.addEventListener("message", (event) => {
    if (event.data && event.data.type === "NEW_VERSION") {
      console.log("‚ö° Neue Version erkannt, Seite wird neu geladen...");
      window.location.reload(true);
    }
  });
}
</script>
<body>
  <h1>Admin <span>Protect-Alert</span></h1>
  <div class="grid" id="homeGrid"></div>
  <div id="contextMenu" class="context-menu"></div>

  <!-- üîÑ Automatische Versionspr√ºfung -->
  <script>
    async function checkVersion() {
      try {
        const res = await fetch("/version.json", { cache: "no-store" });
        const data = await res.json();
        const current = localStorage.getItem("app_version");
        if (current !== data.version) {
          localStorage.setItem("app_version", data.version);
          location.reload(true);
        }
      } catch (err) {
        console.warn("Version konnte nicht gepr√ºft werden:", err);
      }
    }
    setInterval(checkVersion, 30000);
    checkVersion();
  </script>

  <!-- üß© Service Worker Registrierung (f√ºr WebApp-Auto-Update) -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js').then((reg) => {
        reg.addEventListener('updatefound', () => {
          const newSW = reg.installing;
          if (!newSW) return;
          newSW.addEventListener('statechange', () => {
            if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
              newSW.postMessage({ type: 'SKIP_WAITING' });
            }
          });
        });
      });

      navigator.serviceWorker.addEventListener('controllerchange', () => {
        window.location.reload();
      });
    }
  </script>

  <!-- üß© Dezente Version-Anzeige unten rechts -->
  <style>
   #versionStatus {
    position: fixed;
    right: 10px;
    bottom: calc(env(safe-area-inset-bottom, 0px) + 10px);
    font-size: 11px;
    color: rgba(0,0,0,0.6);
    font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    z-index: 9999;
    pointer-events: none;
  }
  </style>

  <div id="versionStatus">Version ‚Ä¶</div>

  <script>
    async function showVersionStatus() {
      const box = document.getElementById("versionStatus");
      try {
        const res = await fetch("/version.json", { cache: "no-store" });
        const data = await res.json();
        const current = localStorage.getItem("app_version");
        const serverVersion = data.version;

        box.textContent = `Version ${serverVersion}`;

        if (current && current !== serverVersion) {
          localStorage.setItem("app_version", serverVersion);
          location.reload(true);
        } else if (!current) {
          localStorage.setItem("app_version", serverVersion);
        }
      } catch (e) {
        console.warn("Version-Check fehlgeschlagen:", e);
      }
    }

    showVersionStatus();
    setInterval(showVersionStatus, 60000);
  </script>

</body>
</html>
